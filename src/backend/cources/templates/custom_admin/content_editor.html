{% load i18n admin_urls static %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Обработчик кнопки "Move Up"
        document.querySelectorAll('.move-up-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                var blockId = button.getAttribute('data-id');
                var currentOrder = parseInt(button.getAttribute('data-order'));

                // Находим блок с меньшим порядком
                var prevBlock = document.querySelector('[data-id="' + (blockId - 1) + '"]');
                if (prevBlock) {
                    var prevOrder = parseInt(prevBlock.getAttribute('data-order'));

                    // Меняем порядки
                    button.setAttribute('data-order', prevOrder);
                    prevBlock.setAttribute('data-order', currentOrder);

                    // Обновляем скрытые поля "order"
                    button.parentElement.previousElementSibling.querySelector('input[name="order"]').value = prevOrder;
                    prevBlock.parentElement.previousElementSibling.querySelector('input[name="order"]').value = currentOrder;
                }
            });
        });

        // Обработчик кнопки "Move Down"
        document.querySelectorAll('.move-down-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                var blockId = button.getAttribute('data-id');
                var currentOrder = parseInt(button.getAttribute('data-order'));

                // Находим блок с большим порядком
                var nextBlock = document.querySelector('[data-id="' + (blockId + 1) + '"]');
                if (nextBlock) {
                    var nextOrder = parseInt(nextBlock.getAttribute('data-order'));

                    // Меняем порядки
                    button.setAttribute('data-order', nextOrder);
                    nextBlock.setAttribute('data-order', currentOrder);

                    // Обновляем скрытые поля "order"
                    button.parentElement.previousElementSibling.querySelector('input[name="order"]').value = nextOrder;
                    nextBlock.parentElement.previousElementSibling.querySelector('input[name="order"]').value = currentOrder;
                }
            });
        });
    });
</script>
<div class="js-inline-admin-formset inline-group" id="{{ inline_admin_formset.formset.prefix }}-group" data-inline-type="stacked" data-inline-formset="{{ inline_admin_formset.inline_formset_data }}">
    <fieldset class="module {{ inline_admin_formset.classes }} card card-outline">
        <div class="card-body">
            {{ inline_admin_formset.formset.management_form }}
            {{ inline_admin_formset.formset.non_form_errors }}

            {% for inline_admin_form in inline_admin_formset %}
                <div class="panel inline-related{% if inline_admin_form.original or inline_admin_form.show_url %} has_original{% endif %}{% if forloop.last and inline_admin_formset.has_add_permission %} empty-form last-related{% endif %}"
                     id="{{ inline_admin_formset.formset.prefix }}-{% if not forloop.last %}{{ forloop.counter0 }}{% else %}empty{% endif %}">
                    <div class="card card-outline {% if not inline_admin_form.original %}new-stacked card-success{% else %}card-secondary{% endif %}">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-tools text-sm">
                                {% if inline_admin_form.original %}
                                    {% if inline_admin_form.model_admin.show_change_link and inline_admin_form.model_admin.has_registered_model %}
                                        <a
                                            href="{% url inline_admin_form.model_admin.opts|admin_urlname:'change' inline_admin_form.original.pk|admin_urlquote %}" 
                                            class="{% if inline_admin_formset.has_change_permission %}inlinechangelink{% else %}inlineviewlink{% endif %}">
                                        {% if inline_admin_formset.has_change_permission %}
                                            <i class="fas fa-pencil-alt fa-sm"> </i>
                                        {% else %}
                                            <i class="fas fa-eye fa-sm"> </i>
                                        {% endif %}
                                        {{ inline_admin_form.original }}
                                        </a>
                                    {% endif %}
                                {% else %}
                                    <i class="fas fa-plus fa-sm text-success"> </i>
                                    {% trans "New" %} {{ inline_admin_formset.opts.verbose_name|capfirst }}
                                {% endif %}
                                </span>
                                {% if inline_admin_form.show_url %}
                                    <a href="{{ inline_admin_form.absolute_url }}" title="{% trans "View on site" %}">
                                        <i class="fas fa-eye fa-sm"> </i>
                                    </a>
                                {% endif %}
                            </h3>

                            {% if inline_admin_formset.formset.can_delete and inline_admin_formset.has_delete_permission and inline_admin_form.original %}
                                <span class="card-tools delete">
                                  {{ inline_admin_form.deletion_field.field }} {{ inline_admin_form.deletion_field.label_tag }}
                                </span>
                            {% endif %}
                        </div>
                        <div class="card-body">
                        {% if inline_admin_form.form.non_field_errors %}{{ inline_admin_form.form.non_field_errors }}{% endif %}
                        
                        {% for fieldset in inline_admin_form %}
                            <fieldset class="module aligned {{ fieldset.classes }}"{% if fieldset.name %} aria-labelledby="{{ prefix }}-{{ id_prefix}}-{{ id_suffix }}-heading"{% endif %}>
                                {% if fieldset.name %}
                                    {% if fieldset.is_collapsible %}<details><summary>{% endif %}
                                    <h{{ heading_level|default:2 }} id="{{ prefix }}-{{ id_prefix}}-{{ id_suffix }}-heading" class="fieldset-heading">{{ fieldset.name }}</h{{ heading_level|default:2 }}>
                                    {% if fieldset.is_collapsible %}</summary>{% endif %}
                                {% endif %}
                                {% if fieldset.description %}
                                    <div class="description">{{ fieldset.description|safe }}</div>
                                {% endif %}
                                {% for line in fieldset %}
                                    <div class="{% if line.fields|length == 1 and line.errors %} errors{% endif %}{% if not line.has_visible_field %} hidden{% endif %}{% for field in line %}{% if field.field.name %} field-{{ field.field.name }}{% endif %}{% endfor %}">
                                        {% for field in line %}
                                            <div>
                                                {% if not line.fields|length == 1 and not field.is_readonly %}{{ field.errors }}{% endif %}
                                                {{ field.field }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endfor %}
                                {% if fieldset.name and fieldset.is_collapsible %}</details>{% endif %}
                            </fieldset>
                        {% endfor %}

                        <div class="card-footer">
                            <button type="button" class="move-up-btn" data-id="{{ inline_admin_form.original.pk }}" data-order="{{ inline_admin_form.original.order }}">Move Up</button>
                            <button type="button" class="move-down-btn" data-id="{{ inline_admin_form.original.pk }}" data-order="{{ inline_admin_form.original.order }}">Move Down</button>
                        </div>
                            
                        {% if inline_admin_form.needs_explicit_pk_field %}{{ inline_admin_form.pk_field.field }}{% endif %}
                        {% if inline_admin_form.fk_field %}{{ inline_admin_form.fk_field.field }}{% endif %}
                        </div>
                        
                    </div>
                </div>
            {% endfor %}
        </div>
    </fieldset>
</div>